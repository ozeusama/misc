#include "base64.h"
#include "util.h"

static const char base64_lookup_enc[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
                                        "abcdefghijklmnopqrstuvwxyz"
                                        "0123456789-_";

static inline char btoc(b8 a)
{
    return base64_lookup_enc[a];
}

static inline size_t strlen_(char *a)
{
    size_t i = 0;
    while (a[i] != '\0')
        i++;
    return i;
}

static const u8 base64_lookup_dec[] = {
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0x3E, 0xFF, 0xFF, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
        0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x19, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0xFF, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0x20, 0x21,
        0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F, 0x30,
        0x31, 0x32, 0x33, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
        0xFF};

static inline b8 ctob(char a)
{
    return base64_lookup_dec[(size_t)a];
}

size_t b8tobase64_malloc_size(size_t s)
{
    return (s + 2) / 3 * 4;
}

void b8tobase64(b8 *a, size_t in_size, char *out)
{
    for (size_t i = 0; i < in_size / 3; i++) {
        out[4 * i + 0] = btoc(a[3 * i] >> 2);
        out[4 * i + 1] = btoc((a[3 * i] << 4 | a[3 * i + 1] >> 4) & 0x3F);
        out[4 * i + 2] = btoc((a[3 * i + 1] << 2 | a[3 * i + 2] >> 6) & 0x3F);
        out[4 * i + 3] = btoc(a[3 * i + 2] & 0x3F);
    }
    switch (in_size % 3) {
    case 0:
        break;
    case 1:
        out[4 * (in_size / 3) + 0] = btoc(a[in_size - 1] >> 2);
        out[4 * (in_size / 3) + 1] = btoc((a[in_size - 1] << 4) & 0x3F);
        out[4 * (in_size / 3) + 2] = '=';
        out[4 * (in_size / 3) + 3] = '=';
        break;
    case 2:
        out[4 * (in_size / 3) + 0] = btoc(a[in_size - 2] >> 2);
        out[4 * (in_size / 3) + 1] = btoc((a[in_size - 2] << 4 | a[in_size - 1] >> 4) & 0x3F);
        out[4 * (in_size / 3) + 2] = btoc((a[in_size - 1] << 2) & 0x3F);
        out[4 * (in_size / 3) + 3] = '=';
        break;
    }
}

size_t base64tob8_malloc_size(char *a)
{
    size_t a_len = strlen_(a);
    if (a[a_len - 2] == '=') {
        return a_len / 4 * 3 - 2;
    } else if (a[a_len - 1] == '=') {
        return a_len / 4 * 3 - 1;
    } else {
        return a_len / 4 * 3;
    }
}

void base64tob8(char *a, b8 *out)
{
    u8 b1, b2, b3, b4;
    size_t a_len = strlen_(a);
    for (size_t i = 0; i < (a_len - 4) / 4; i++) {
        b1 = ctob(a[4 * i + 0]);
        b2 = ctob(a[4 * i + 1]);
        b3 = ctob(a[4 * i + 2]);
        b4 = ctob(a[4 * i + 3]);
        out[3 * i + 0] = b1 << 2 | b2 >> 4;
        out[3 * i + 1] = b2 << 4 | b3 >> 2;
        out[3 * i + 2] = b3 << 6 | b4;
    }
    if (a[a_len - 2] == '=') {
        b1 = ctob(a[a_len - 4]);
        b2 = ctob(a[a_len - 3]);
        out[a_len / 4 * 3 - 3] = b1 << 2 | b2 >> 4;
    } else if (a[a_len - 1] == '=') {
        b1 = ctob(a[a_len - 4]);
        b2 = ctob(a[a_len - 3]);
        b3 = ctob(a[a_len - 2]);
        out[a_len / 4 * 3 - 3] = b1 << 2 | b2 >> 4;
        out[a_len / 4 * 3 - 2] = b2 << 4 | b3 >> 2;
    } else {
        b1 = ctob(a[a_len - 4]);
        b2 = ctob(a[a_len - 3]);
        b3 = ctob(a[a_len - 2]);
        b4 = ctob(a[a_len - 1]);
        out[a_len / 4 * 3 - 3] = b1 << 2 | b2 >> 4;
        out[a_len / 4 * 3 - 2] = b2 << 4 | b3 >> 2;
        out[a_len / 4 * 3 - 1] = b3 << 6 | b4;
    }
}
